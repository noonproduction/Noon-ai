<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Noon AI Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root { --bg-color: #000000; --text-color: #ffffff; --glass-bg: rgba(255, 255, 255, 0.08); --glass-border: rgba(255, 255, 255, 0.1); --user-msg-bg: linear-gradient(135deg, #2563eb, #9333ea); --bot-msg-bg: rgba(255, 255, 255, 0.1); --sidebar-bg: #0f0f10; }
        [data-theme="light"] { --bg-color: #f0f4f8; --text-color: #1f2937; --glass-bg: rgba(255, 255, 255, 0.6); --glass-border: rgba(255, 255, 255, 0.4); --user-msg-bg: linear-gradient(135deg, #06b6d4, #3b82f6); --bot-msg-bg: #ffffff; --sidebar-bg: #ffffff; }
        html, body { height: 100dvh; overflow: hidden; font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-color); transition: background 0.3s; margin: 0; }
        .safe-area-top { padding-top: max(10px, env(safe-area-inset-top)); }
        .safe-area-bottom { padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        #onboarding-overlay { position: fixed; inset: 0; z-index: 200; background: var(--bg-color); display: flex; flex-direction: column; transition: opacity 0.5s; visibility: visible; }
        #onboarding-overlay.hidden-all { display: none !important; visibility: hidden; }
        .slide { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 20px; animation: fadeIn 0.5s; }
        .slide.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #app-wrapper { display: flex; height: 100%; width: 100%; overflow: hidden; }
        #sidebar { width: 280px; background: var(--sidebar-bg); height: 100%; position: absolute; left: -280px; top: 0; z-index: 50; transition: transform 0.3s ease; border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; }
        #sidebar.open { transform: translateX(280px); box-shadow: 5px 0 30px rgba(0,0,0,0.5); }
        .history-item { padding: 12px; margin: 5px 10px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; opacity: 0.7; }
        .history-item.active { background: var(--glass-bg); opacity: 1; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 40; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(2px); }
        #overlay.show { opacity: 1; pointer-events: auto; }
        #main-chat { flex: 1; display: flex; flex-direction: column; position: relative; z-index: 10; height: 100%; }
        .glass { background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--glass-border); }
        .msg { max-width: 85%; padding: 12px 16px; margin-bottom: 15px; font-size: 0.95rem; line-height: 1.5; border-radius: 18px; word-wrap: break-word; }
        .user-msg { align-self: flex-end; background: var(--user-msg-bg); color: white; border-bottom-right-radius: 4px; }
        .bot-msg { align-self: flex-start; background: var(--bot-msg-bg); color: var(--text-color); border-bottom-left-radius: 4px; border: 1px solid var(--glass-border); }
        #toast { position: fixed; top: 80px; left: 50%; transform: translate(-50%, -20px); background: #10b981; color: white; padding: 8px 16px; border-radius: 50px; opacity: 0; transition: 0.3s; z-index: 100; pointer-events: none; }
        #toast.show { opacity: 1; transform: translate(-50%, 0); }
    </style>
</head>
<body data-theme="dark">

    <div id="onboarding-overlay">
        <div class="slide active" id="slide-1">
            <h1 class="text-3xl font-bold mb-4">Welcome to Noon AI</h1>
            <p class="opacity-70 px-6">Smart, Fast & Secure AI Assistant.</p>
        </div>
        <div class="slide" id="slide-2">
            <h1 class="text-3xl font-bold mb-4">Image Magic</h1>
            <p class="opacity-70 px-6">Create stunning images with words.</p>
        </div>
        <div class="w-full p-8 mt-auto safe-area-bottom">
            <button onclick="nextSlide()" id="next-btn" class="w-full bg-white text-black font-bold text-lg py-4 rounded-2xl shadow-lg transition">Next</button>
        </div>
    </div>

    <div id="overlay" onclick="closeSidebar()"></div>

    <div id="app-wrapper">
        <div id="sidebar">
            <div class="p-4 safe-area-top"><button onclick="startNewChat()" class="w-full glass p-3 rounded-xl flex items-center gap-3"><i class="fas fa-plus text-cyan-400"></i><span>New Chat</span></button></div>
            <div id="history-list" class="flex-1 overflow-y-auto"></div>
            <div class="p-4 border-t border-white/10"><button onclick="toggleSettings()" class="flex items-center gap-3 opacity-70 w-full"><i class="fas fa-cog"></i> Settings</button></div>
        </div>

        <div id="main-chat">
            <div class="glass flex items-center justify-between px-4 py-3 m-2 rounded-2xl shadow-lg z-20 safe-area-top shrink-0">
                <div class="flex items-center gap-3 cursor-pointer" onclick="toggleSidebar()">
                    <i class="fas fa-bars opacity-80"></i>
                    <img src="./IMG-20260206-WA0016.jpg" class="w-9 h-9 rounded-lg object-contain bg-white/10 p-0.5 border border-white/10" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4712/4712035.png'">
                    <h1 class="font-bold text-lg">Noon AI</h1>
                </div>
                <button onclick="toggleTheme()" class="w-9 h-9 rounded-full glass flex items-center justify-center"><i class="fas fa-moon" id="theme-icon"></i></button>
            </div>

            <div id="chat-box" class="flex-1 overflow-y-auto px-4 py-2 flex flex-col"></div>

            <div id="image-preview" class="hidden px-4 py-2 mx-4 mb-2 bg-black/40 rounded-xl flex items-center justify-between shrink-0">
                <div class="flex items-center gap-3"><img id="preview-img" class="w-10 h-10 rounded-lg object-cover"><span>Attached</span></div>
                <button onclick="removeImage()"><i class="fas fa-times"></i></button>
            </div>

            <div class="p-3 z-20 safe-area-bottom shrink-0">
                <div class="glass p-1.5 pl-2 rounded-[28px] flex items-center gap-2">
                    <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImage(event)">
                    <button onclick="document.getElementById('image-input').click()" class="w-10 h-10 text-cyan-400"><i class="fas fa-plus"></i></button>
                    <button onclick="generateImage(event)" class="w-10 h-10 text-purple-400"><i class="fas fa-palette"></i></button>
                    <form class="flex-1 flex gap-2" onsubmit="sendMessage(event)">
                        <input type="text" id="msg-input" class="w-full bg-transparent outline-none text-sm px-2" placeholder="Message Noon AI..." autocomplete="off">
                        <button type="submit" class="w-10 h-10 bg-blue-600 rounded-full text-white"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-[60] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="glass w-full max-w-sm rounded-3xl p-6 relative" id="settings-content">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
            <div class="mt-4 space-y-2">
                <button onclick="resetOnboarding()" class="w-full p-3 rounded-xl bg-blue-500/10 text-blue-400 border border-blue-500/20">Reset Onboarding</button>
                <button onclick="clearAllHistory()" class="w-full p-3 rounded-xl bg-red-500/10 text-red-400 border border-red-500/20">Clear History</button>
            </div>
        </div>
    </div>
    <div id="toast">Saved!</div>

    <script>
        const BACKEND_URL = "https://879a9d65-a264-4177-9167-2711221fa0f5-00-3j9ytr2tbdy5b.sisko.replit.dev/chat";
        let isDark = true; imgData = null; sessions = []; currentSessionId = null; currentSlide = 1;

        // ðŸ”¥ FIXED ONBOARDING CHECK
        window.onload = function() {
            const isComplete = localStorage.getItem('noon_v3_onboarding');
            if (isComplete === 'true') {
                document.getElementById('onboarding-overlay').classList.add('hidden-all');
            }
            loadSessions();
        };

        function nextSlide() {
            if (currentSlide < 2) {
                document.getElementById(`slide-${currentSlide}`).classList.remove('active');
                currentSlide++;
                document.getElementById(`slide-${currentSlide}`).classList.add('active');
                document.getElementById('next-btn').innerText = "Get Started";
            } else {
                localStorage.setItem('noon_v3_onboarding', 'true');
                document.getElementById('onboarding-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('onboarding-overlay').classList.add('hidden-all'), 500);
            }
        }

        async function generateImage(e) {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const prompt = input.value.trim();
            if (!prompt) return;
            addMsg(`ðŸŽ¨ Generate: "${prompt}"`, 'user');
            input.value = '';
            const loadId = showLoad("Painting...");
            const seed = Math.floor(Math.random() * 100000);
            const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?seed=${seed}&width=720&height=720&nologo=true`;
            
            // ðŸ”¥ DIRECT LOAD FIX
            const img = new Image();
            img.onload = () => {
                rmLoad(loadId);
                const html = `Image: <b>${prompt}</b><br><div class='relative'><img src='${imageUrl}' class='rounded-xl mt-2'><button onclick="downloadImage('${imageUrl}')" class='absolute bottom-2 right-2 bg-black/50 p-2 rounded-full'><i class='fas fa-download'></i></button></div>`;
                addMsg(html, 'bot');
            };
            img.onerror = () => {
                rmLoad(loadId);
                addMsg(`Failed to load. <a href='${imageUrl}' target='_blank' class='text-blue-400 underline'>Click here to see it</a>`, 'bot');
            };
            img.src = imageUrl;
        }

        async function downloadImage(url) {
            window.open(url, '_blank');
        }

        function loadSessions() {
            const saved = localStorage.getItem('noon_sessions');
            if (saved) { sessions = JSON.parse(saved); if (sessions.length > 0) loadChat(sessions[0].id); else startNewChat(); }
            else startNewChat();
            renderSidebar();
        }
        function startNewChat() { const id = Date.now().toString(); sessions.unshift({id, title: "New Chat", messages: [{html: "Hello! How can I help?", role: "bot"}]}); currentSessionId = id; saveSessions(); renderChat(sessions[0].messages); renderSidebar(); closeSidebar(); }
        function loadChat(id) { currentSessionId = id; const s = sessions.find(x => x.id === id); if(s) { renderChat(s.messages); renderSidebar(); closeSidebar(); } }
        function saveSessions() { localStorage.setItem('noon_sessions', JSON.stringify(sessions)); }
        function renderSidebar() { const list = document.getElementById('history-list'); list.innerHTML = sessions.map(s => `<div class='history-item ${s.id === currentSessionId ? 'active' : ''}' onclick="loadChat('${s.id}')"><i class='fas fa-message'></i> <span class='truncate'>${s.title}</span></div>`).join(''); }
        function renderChat(msgs) { document.getElementById('chat-box').innerHTML = msgs.map(m => `<div class='msg ${m.role === 'user' ? 'user-msg' : 'bot-msg'}'>${m.html}</div>`).join(''); document.getElementById('chat-box').scrollTop = 99999; }
        async function sendMessage(e) {
            e.preventDefault(); const input = document.getElementById('msg-input'); const text = input.value.trim(); if (!text && !imgData) return;
            const session = sessions.find(s => s.id === currentSessionId);
            if(session.messages.length === 1 && text) session.title = text.slice(0, 20);
            let html = text + (imgData ? `<br><img src='${imgData}' class='rounded-lg'>` : '');
            addMsg(html, 'user'); input.value = ''; const toSendImg = imgData; removeImage(); const loadId = showLoad();
            try {
                const res = await fetch(BACKEND_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({message: text, image: toSendImg}) });
                const data = await res.json(); rmLoad(loadId); addMsg(data.reply, 'bot');
            } catch { rmLoad(loadId); addMsg("Server busy. Try again.", 'bot'); }
        }
        function addMsg(html, role) { const s = sessions.find(x => x.id === currentSessionId); s.messages.push({html, role}); saveSessions(); renderChat(s.messages); }
        function showLoad(t="Thinking...") { const id = 'l-'+Date.now(); document.getElementById('chat-box').innerHTML += `<div id='${id}' class='msg bot-msg opacity-50'><i class='fas fa-circle-notch fa-spin'></i> ${t}</div>`; return id; }
        function rmLoad(id) { document.getElementById(id)?.remove(); }
        function resetOnboarding() { localStorage.removeItem('noon_v3_onboarding'); location.reload(); }
        function clearAllHistory() { localStorage.removeItem('noon_sessions'); sessions = []; startNewChat(); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('show'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('show'); }
        function toggleTheme() { isDark = !isDark; document.body.setAttribute('data-theme', isDark ? 'dark' : 'light'); }
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function handleImage(e) { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = (x) => { imgData = x.target.result; document.getElementById('preview-img').src = imgData; document.getElementById('image-preview').classList.remove('hidden'); }; r.readAsDataURL(f); }
        function removeImage() { imgData = null; document.getElementById('image-preview').classList.add('hidden'); }
    </script>
</body>
</html>
