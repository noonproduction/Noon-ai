<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Noon AI Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
            --user-msg-bg: linear-gradient(135deg, #2563eb, #9333ea);
            --bot-msg-bg: rgba(255, 255, 255, 0.1);
            --sidebar-bg: #0f0f10;
        }

        [data-theme="light"] {
            --bg-color: #f0f4f8;
            --text-color: #1f2937;
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(255, 255, 255, 0.4);
            --user-msg-bg: linear-gradient(135deg, #06b6d4, #3b82f6);
            --bot-msg-bg: #ffffff;
            --sidebar-bg: #ffffff;
        }

        html, body { height: 100dvh; overflow: hidden; font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-color); transition: background 0.3s; margin: 0; }
        .safe-area-top { padding-top: max(10px, env(safe-area-inset-top)); }
        .safe-area-bottom { padding-bottom: max(10px, env(safe-area-inset-bottom)); }

        /* ONBOARDING STYLES */
        #onboarding-overlay { position: fixed; inset: 0; z-index: 200; background: var(--bg-color); display: flex; flex-direction: column; transition: opacity 0.5s; }
        #onboarding-overlay.hidden-anim { opacity: 0; pointer-events: none; }
        .slide { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 20px; animation: fadeIn 0.5s; }
        .slide.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* LAYOUT & SIDEBAR */
        #app-wrapper { display: flex; height: 100%; width: 100%; overflow: hidden; }
        #sidebar { width: 280px; background: var(--sidebar-bg); height: 100%; position: absolute; left: -280px; top: 0; z-index: 50; transition: transform 0.3s ease; border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; }
        #sidebar.open { transform: translateX(280px); box-shadow: 5px 0 30px rgba(0,0,0,0.5); }
        .history-item { padding: 12px; margin: 5px 10px; border-radius: 12px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; opacity: 0.7; }
        .history-item:hover, .history-item.active { background: var(--glass-bg); opacity: 1; }
        
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 40; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(2px); }
        #overlay.show { opacity: 1; pointer-events: auto; }

        #main-chat { flex: 1; display: flex; flex-direction: column; position: relative; z-index: 10; height: 100%; }

        .glass { background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--glass-border); }
        .msg { max-width: 85%; padding: 12px 16px; margin-bottom: 15px; font-size: 0.95rem; line-height: 1.5; border-radius: 18px; word-wrap: break-word; }
        .user-msg { align-self: flex-end; background: var(--user-msg-bg); color: white; border-bottom-right-radius: 4px; }
        .bot-msg { align-self: flex-start; background: var(--bot-msg-bg); color: var(--text-color); border-bottom-left-radius: 4px; border: 1px solid var(--glass-border); }
        .msg img { max-width: 100%; border-radius: 12px; margin-top: 8px; }

        #toast { position: fixed; top: 80px; left: 50%; transform: translate(-50%, -20px); background: #10b981; color: white; padding: 8px 16px; border-radius: 50px; opacity: 0; transition: 0.3s; z-index: 100; pointer-events: none; }
        #toast.show { opacity: 1; transform: translate(-50%, 0); }
    </style>
</head>
<body data-theme="dark">

    <div id="onboarding-overlay" class="hidden">
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-[-1]">
             <div class="absolute top-[-10%] left-[-10%] w-[70vw] h-[70vw] bg-blue-600/30 blur-[80px] rounded-full animate-pulse"></div>
             <div class="absolute bottom-[-10%] right-[-10%] w-[70vw] h-[70vw] bg-purple-600/30 blur-[80px] rounded-full animate-pulse"></div>
        </div>

        <div class="slide active" id="slide-1">
            <div class="w-24 h-24 bg-gradient-to-tr from-cyan-400 to-blue-600 rounded-3xl flex items-center justify-center shadow-2xl mb-8">
                <i class="fas fa-sparkles text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold mb-4">Welcome to Noon AI</h1>
            <p class="text-lg opacity-70 px-6">Experience the power of advanced AI right in your pocket. Smart, Fast & Secure.</p>
        </div>

        <div class="slide" id="slide-2">
            <div class="w-24 h-24 bg-gradient-to-tr from-purple-400 to-pink-600 rounded-3xl flex items-center justify-center shadow-2xl mb-8">
                <i class="fas fa-eye text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold mb-4">Vision Capabilities</h1>
            <p class="text-lg opacity-70 px-6">Send photos and let Noon AI analyze and describe them for you instantly.</p>
        </div>

        <div class="slide" id="slide-3">
            <div class="w-24 h-24 bg-gradient-to-tr from-green-400 to-emerald-600 rounded-3xl flex items-center justify-center shadow-2xl mb-8">
                <i class="fas fa-shield-alt text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold mb-4">Private & Secure</h1>
            <p class="text-lg opacity-70 px-6">Your chat history is stored locally on your device for maximum privacy.</p>
        </div>

        <div class="w-full p-8 mt-auto safe-area-bottom">
            <button onclick="nextSlide()" id="next-btn" class="w-full bg-white text-black font-bold text-lg py-4 rounded-2xl shadow-lg active:scale-95 transition">
                Next
            </button>
            <button onclick="skipOnboarding()" class="w-full text-center mt-4 opacity-50 text-sm p-2">Skip</button>
        </div>
    </div>

    <div id="overlay" onclick="closeSidebar()"></div>

    <div id="app-wrapper">
        <div id="sidebar">
            <div class="p-4 safe-area-top">
                <button onclick="startNewChat()" class="w-full glass p-3 rounded-xl flex items-center gap-3 hover:bg-white/10 transition group">
                    <i class="fas fa-plus text-cyan-400 group-hover:scale-110 transition"></i>
                    <span class="font-medium">New Chat</span>
                </button>
            </div>
            <div class="px-4 pb-2 text-xs font-bold opacity-50 uppercase tracking-wider">Recent</div>
            <div class="flex-1 overflow-y-auto" id="history-list"></div>
            <div class="p-4 border-t border-white/10">
                <button onclick="toggleSettings()" class="flex items-center gap-3 opacity-70 hover:opacity-100 transition p-2 w-full">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>
        </div>

        <div id="main-chat">
            <div class="glass flex items-center justify-between px-4 py-3 m-2 rounded-2xl shadow-lg z-20 safe-area-top shrink-0">
                <div class="flex items-center gap-3 cursor-pointer" onclick="toggleSidebar()">
                    <i class="fas fa-bars text-xl opacity-80"></i>
                    <img src="./IMG-20260206-WA0016.jpg" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4712/4712035.png'" class="w-9 h-9 rounded-lg object-contain bg-white/10 p-0.5 border border-white/10">
                    <div>
                        <h1 class="font-bold text-lg leading-tight">Noon AI</h1>
                        <div class="flex items-center gap-1.5"><span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span><span class="text-[10px] font-medium opacity-70">PRO</span></div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleTheme()" class="w-9 h-9 rounded-full glass flex items-center justify-center hover:bg-white/10"><i class="fas fa-moon" id="theme-icon"></i></button>
                </div>
            </div>

            <div id="chat-box" class="flex-1 overflow-y-auto px-4 py-2 flex flex-col scroll-smooth"></div>

            <div id="image-preview" class="hidden px-4 py-2 mx-4 mb-2 bg-black/40 backdrop-blur-md rounded-xl border border-white/10 items-center justify-between shrink-0">
                <div class="flex items-center gap-3">
                    <img id="preview-img" src="" class="w-10 h-10 rounded-lg object-cover border border-white/20">
                    <span class="text-xs opacity-80">Photo attached</span>
                </div>
                <button onclick="removeImage()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>

            <div class="p-3 z-20 safe-area-bottom shrink-0">
                <div class="glass p-1.5 pl-2 rounded-[28px] flex items-center gap-2 shadow-xl">
                    <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImage(event)">
                    <button onclick="document.getElementById('image-input').click()" class="w-10 h-10 flex items-center justify-center text-cyan-400 hover:bg-white/10 rounded-full transition active:scale-90"><i class="fas fa-plus text-lg"></i></button>
                    <form class="flex-1 flex gap-2" onsubmit="sendMessage(event)">
                        <input type="text" id="msg-input" class="w-full bg-transparent outline-none text-sm px-2" style="color: var(--text-color);" placeholder="Message Noon AI..." autocomplete="off">
                        <button type="submit" class="w-10 h-10 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-full flex items-center justify-center text-white shadow-lg"><i class="fas fa-paper-plane text-sm translate-x-px translate-y-px"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-[60] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="glass w-full max-w-sm rounded-3xl p-6 transform scale-95 opacity-0 transition-all duration-300 relative" id="settings-content">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-400 p-2"><i class="fas fa-times"></i></button>
            <div class="text-center">
                <img src="./IMG-20260206-WA0016.jpg" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4712/4712035.png'" class="w-16 h-16 rounded-xl mx-auto mb-2 shadow-lg object-contain bg-white/10 p-1">
                <h2 class="text-xl font-bold">Noon AI Pro</h2>
                <p class="text-xs opacity-60">Version 3.0 (Onboarding)</p>
            </div>
            <div class="mt-4 space-y-2">
                <button onclick="resetOnboarding()" class="w-full p-3 rounded-xl bg-blue-500/10 text-blue-400 border border-blue-500/20 flex items-center gap-3"><i class="fas fa-redo"></i> Reset Onboarding</button>
                <button onclick="clearAllHistory()" class="w-full p-3 rounded-xl bg-red-500/10 text-red-400 border border-red-500/20 flex items-center gap-3"><i class="fas fa-trash"></i> Delete All History</button>
                <div class="p-3 rounded-xl bg-white/5 border border-white/10 text-center text-xs opacity-70">connect.noonai@gmail.com</div>
            </div>
        </div>
    </div>

    <div id="toast"><i class="fas fa-check-circle mr-2"></i> Saved!</div>

    <script>
        const BACKEND_URL = "https://879a9d65-a264-4177-9167-2711221fa0f5-00-3j9ytr2tbdy5b.sisko.replit.dev/chat";
        let isDark = true;
        let imgData = null;
        let sessions = [];
        let currentSessionId = null;

        // ONBOARDING VARIABLES
        let currentSlide = 1;
        const totalSlides = 3;

        window.onload = function() {
            // Check Onboarding Status
            if (!localStorage.getItem('noon_onboarding_complete')) {
                document.getElementById('onboarding-overlay').classList.remove('hidden');
            }
            
            loadSessions();
            const savedTheme = localStorage.getItem('noon_theme');
            if(savedTheme === 'light') toggleTheme();
        };

        // --- ONBOARDING LOGIC ---
        function nextSlide() {
            if (currentSlide < totalSlides) {
                // Hide current
                document.getElementById(`slide-${currentSlide}`).classList.remove('active');
                currentSlide++;
                // Show next
                document.getElementById(`slide-${currentSlide}`).classList.add('active');
                
                // Change Button Text if last slide
                if (currentSlide === totalSlides) {
                    document.getElementById('next-btn').innerText = "Get Started";
                }
            } else {
                finishOnboarding();
            }
        }

        function finishOnboarding() {
            localStorage.setItem('noon_onboarding_complete', 'true');
            const overlay = document.getElementById('onboarding-overlay');
            overlay.classList.add('hidden-anim');
            setTimeout(() => overlay.classList.add('hidden'), 500);
        }

        function skipOnboarding() {
            finishOnboarding();
        }

        function resetOnboarding() {
            localStorage.removeItem('noon_onboarding_complete');
            location.reload();
        }

        // --- MAIN APP LOGIC ---

        function loadSessions() {
            const saved = localStorage.getItem('noon_sessions');
            if (saved) {
                sessions = JSON.parse(saved);
                if (sessions.length > 0) loadChat(sessions[0].id);
                else startNewChat();
            } else {
                startNewChat();
            }
            renderSidebar();
        }

        function startNewChat() {
            const newId = Date.now().toString();
            const newSession = { id: newId, title: "New Chat", messages: [{ html: "Hello! How can I help you today?", role: "bot" }] };
            sessions.unshift(newSession);
            currentSessionId = newId;
            saveSessions();
            renderSidebar();
            renderChat(newSession.messages);
            closeSidebar();
        }

        function loadChat(id) {
            currentSessionId = id;
            const session = sessions.find(s => s.id === id);
            if (session) {
                renderChat(session.messages);
                renderSidebar();
                closeSidebar();
            }
        }

        function deleteSession(e, id) {
            e.stopPropagation();
            if(confirm("Delete this chat?")) {
                sessions = sessions.filter(s => s.id !== id);
                saveSessions();
                if(sessions.length === 0) startNewChat();
                else if(currentSessionId === id) loadChat(sessions[0].id);
                else renderSidebar();
            }
        }

        function saveSessions() { localStorage.setItem('noon_sessions', JSON.stringify(sessions)); }

        function renderSidebar() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            sessions.forEach(s => {
                const isActive = s.id === currentSessionId ? 'active' : '';
                const div = document.createElement('div');
                div.className = `history-item ${isActive}`;
                div.onclick = () => loadChat(s.id);
                div.innerHTML = `<i class="fas fa-message text-cyan-400"></i><span class="flex-1 truncate">${s.title}</span><button onclick="deleteSession(event, '${s.id}')" class="opacity-50 hover:text-red-400 p-1"><i class="fas fa-trash"></i></button>`;
                list.appendChild(div);
            });
        }

        function renderChat(messages) {
            const box = document.getElementById('chat-box');
            box.innerHTML = '';
            messages.forEach(msg => addMsgToUI(msg.html, msg.role, false));
            box.scrollTop = box.scrollHeight;
        }

        async function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text && !imgData) return;

            const session = sessions.find(s => s.id === currentSessionId);
            if (session.messages.length <= 1 && text) {
                session.title = text.substring(0, 20) + (text.length > 20 ? "..." : "");
                renderSidebar();
            }

            let displayHtml = text;
            if (imgData) displayHtml += `<br><img src="${imgData}">`;
            
            addMsg(displayHtml, 'user');
            input.value = '';
            const toSendImg = imgData;
            removeImage();
            const loadId = showLoad();

            try {
                const res = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, image: toSendImg })
                });
                const data = await res.json();
                rmLoad(loadId);
                addMsg(data.reply, 'bot');
            } catch {
                rmLoad(loadId);
                addMsg("Brain is sleeping... Waking up! Try again in 10s.", 'bot');
            }
        }

        function addMsg(html, role) {
            const session = sessions.find(s => s.id === currentSessionId);
            if(session) { session.messages.push({ html: html, role: role }); saveSessions(); }
            addMsgToUI(html, role, true);
        }

        function addMsgToUI(html, role, scroll) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = role === 'user' ? 'user-msg msg' : 'bot-msg msg';
            if (role === 'bot') {
                html = `<div class="flex items-center gap-2 mb-1 text-cyan-400 font-bold text-xs"><i class="fas fa-robot"></i> Noon AI</div>` + 
                       html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>') +
                       `<div class="flex gap-4 mt-2 pt-2 border-t border-white/10 opacity-50"><button onclick="toast()" class="hover:text-green-400"><i class="fas fa-thumbs-up"></i></button><button onclick="toast()" class="hover:text-red-400"><i class="fas fa-thumbs-down"></i></button></div>`;
            }
            div.innerHTML = html;
            box.appendChild(div);
            if(scroll) box.scrollTop = box.scrollHeight;
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            if(sb.classList.contains('open')) { sb.classList.remove('open'); ov.classList.remove('show'); } 
            else { sb.classList.add('open'); ov.classList.add('show'); }
        }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('show'); }

        function toggleTheme() {
            isDark = !isDark;
            document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').className = isDark ? 'fas fa-moon' : 'fas fa-sun text-orange-400';
            localStorage.setItem('noon_theme', isDark ? 'dark' : 'light');
        }

        function toggleSettings() {
            const m = document.getElementById('settings-modal');
            const c = document.getElementById('settings-content');
            if (m.classList.contains('hidden')) {
                m.classList.remove('hidden');
                setTimeout(() => { c.classList.remove('scale-95','opacity-0'); c.classList.add('scale-100','opacity-100'); }, 10);
            } else {
                c.classList.remove('scale-100','opacity-100'); c.classList.add('scale-95','opacity-0');
                setTimeout(() => m.classList.add('hidden'), 300);
            }
            closeSidebar();
        }

        function clearAllHistory() {
            if(confirm("Delete ALL chats?")) { localStorage.removeItem('noon_sessions'); sessions = []; startNewChat(); toggleSettings(); }
        }

        function handleImage(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { imgData = e.target.result; document.getElementById('preview-img').src = imgData; document.getElementById('image-preview').classList.remove('hidden'); document.getElementById('image-preview').classList.add('flex'); };
            reader.readAsDataURL(file);
        }
        function removeImage() { imgData = null; document.getElementById('image-input').value = ''; document.getElementById('image-preview').classList.add('hidden'); document.getElementById('image-preview').classList.remove('flex'); }
        function showLoad() { const id = 'l-' + Date.now(); const box = document.getElementById('chat-box'); const div = document.createElement('div'); div.id = id; div.className = 'bot-msg msg flex items-center gap-2 text-gray-400'; div.innerHTML = `<i class="fas fa-circle-notch fa-spin text-cyan-400"></i> Thinking...`; box.appendChild(div); box.scrollTop = box.scrollHeight; return id; }
        function rmLoad(id) { document.getElementById(id)?.remove(); }
        function toast() { const t = document.getElementById('toast'); t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
    </script>
</body>
</html>
